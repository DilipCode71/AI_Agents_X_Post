
import express from "express";
import dotenv from "dotenv";
import cron from "node-cron";
import { fetchLatestTechNews } from "./services/fetchNews.js";
import { generateTweetFromNews } from "./services/generateTweet.js";
import { postToTwitter } from "./services/postToTwitter.js";

dotenv.config();
const app = express();

app.get("/", (req, res) => {
  res.send("🤖 AI Tweet Bot is running!");
});


app.get("/tweet", async (req, res) => {
  try {
    const news = await fetchLatestTechNews();
    console.log("📰 News fetched:", Array.isArray(news) ? news.length : typeof news);

    const tweet = await generateTweetFromNews(news);
  console.log("✍️ Tweet preview:", tweet?.slice(0, 100));

    if (tweet) {
      await postToTwitter(tweet);
      return res.send("✅ Tweet posted successfully!");
    }
     res.send("⚠️ No tweet generated");
  } catch (error) {
   console.error("❌ Tweet Error:", error.message);
   res.status(500).send("❌ Error generating or posting tweet");
  }
});

if (process.env.RUN_LOCAL_CRON === "true") {
  console.log("🕗 Cron job active locally: Will run at 8:00 AM daily");

  cron.schedule("0 8 * * *", async () => {
    console.log("⏰ Running local scheduled tweet job...");

    try {
      const news = await fetchLatestTechNews();
      console.log("📰 News:", news);

      const tweet = await generateTweetFromNews(news);
      console.log("✍️ Tweet:", tweet);

      if (tweet) {
        await postToTwitter(tweet);
        console.log("✅ Tweet posted via local cron");
      } else {
        console.log("⚠️ No tweet generated by local cron");
      }
    } catch (error) {
      console.error("❌ Local Cron Error:", error.message);
    }
  });
}

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`🚀 Server running at http://localhost:${PORT}`);
});
